name: Build and Test

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - "*.md"
  push:
    branches:
      - main
    paths-ignore:
      - "*.md"
  release:
    types: [published]

concurrency:
  group: ${{ github.event_name }}-${{ github.event.number || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-test:
    name: Build, Lint, and Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu

          - os: windows-latest
            target: x86_64-pc-windows-msvc

          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Setup Dev Drive (Windows)
        if: runner.os == 'Windows'
        id: devdrive
        uses: samypr100/setup-dev-drive@v4
        with:
          drive-size: 4GB
          drive-format: ReFS
          drive-type: Fixed
          workspace-copy: true
          native-dev-drive: true
          env-mapping: |
            CARGO_HOME,{{ DEV_DRIVE }}/.cargo
            RUSTUP_HOME,{{ DEV_DRIVE }}/.rustup

      - name: Configure Windows environment for Dev Drive
        if: runner.os == 'Windows'
        shell: pwsh
        run: echo "CARGO_TARGET_DIR=${{ env.DEV_DRIVE_WORKSPACE }}/target" >> $env:GITHUB_ENV

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}
          rustflags: ""
          cache-key: ${{ matrix.target }}
          cache-workspaces: ${{ env.DEV_DRIVE_WORKSPACE || github.workspace }}
          components: rustc, rust-std, cargo, rustfmt, clippy

      - name: Build
        working-directory: ${{ runner.os == 'Windows' && env.DEV_DRIVE_WORKSPACE || github.workspace }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Check formatting
        if: success() || failure()
        working-directory: ${{ runner.os == 'Windows' && env.DEV_DRIVE_WORKSPACE || github.workspace }}
        run: cargo fmt -- --check

      - name: Check clippy
        if: success() || failure()
        working-directory: ${{ runner.os == 'Windows' && env.DEV_DRIVE_WORKSPACE || github.workspace }}
        shell: bash
        run: |
          cargo clippy --release --all-targets --all-features -- \
            -D clippy::suspicious -D clippy::style -D clippy::complexity \
            -D clippy::perf -D clippy::dbg_macro -D clippy::todo \
            -D clippy::unimplemented -D warnings

      - name: Run unit and integration tests
        if: (success() || failure()) && (contains(matrix.target, 'x86_64') || contains(matrix.target, 'aarch64'))
        working-directory: ${{ runner.os == 'Windows' && env.DEV_DRIVE_WORKSPACE || github.workspace }}
        run: cargo test --release --target ${{ matrix.target }}

      - name: Archive binary (*nix)
        if: (success() || failure()) && !contains(matrix.os, 'windows')
        working-directory: ./target/${{ matrix.target }}/release
        run: tar -cvf binary.tar gcpsql && mv binary.tar ../../..

      - name: Archive binary (Windows)
        shell: bash
        if: (success() || failure()) && contains(matrix.os, 'windows')
        run: |
          cd "${{ env.DEV_DRIVE_WORKSPACE }}/target/${{ matrix.target }}/release"
          tar -cvf binary.tar gcpsql.exe
          cp binary.tar "$GITHUB_WORKSPACE/"

      - name: Upload binary artifact
        if: success() || failure()
        uses: actions/upload-artifact@v5
        with:
          name: binary-${{ matrix.target }}
          path: binary.tar

  publish:
    name: Publish binaries
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: build-test
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    env:
      EXPECTED_TARGETS: |
        x86_64-unknown-linux-gnu
        x86_64-pc-windows-msvc
        aarch64-apple-darwin

    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Download binary artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: binary-*

      - name: Extract & rename binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          while IFS= read -r target; do
            [[ -z "$target" ]] && continue
            dir="binary-${target}"
            if [[ ! -d "$dir" ]]; then
              echo "::error::artifact for $target not found"
              exit 1
            fi

            tar -xf "$dir/binary.tar" -C "$dir"

            if [[ "$target" == *windows-msvc ]]; then
              mv "$dir/gcpsql.exe" "dist/gcpsql-${target}.exe"
            else
              mv "$dir/gcpsql" "dist/gcpsql-${target}"
              chmod +x "dist/gcpsql-${target}"
            fi
          done <<< "$EXPECTED_TARGETS"

      - name: Upload assets to existing Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: dist/*
          draft: false
          prerelease: ${{ github.event.release.prerelease }}
          fail_on_unmatched_files: true

  delete-artifacts:
    name: Delete Artifacts
    runs-on: ubuntu-latest
    if: always()
    needs: [publish]
    steps:
      - name: Delete binary artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: binary-*
